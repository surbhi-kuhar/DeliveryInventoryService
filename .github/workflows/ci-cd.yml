name: CI/CD for DeliveryInventoryService

on:
  push:
    branches: [ main ]  # âœ… Change if your branch differs

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Step 2: Set up gcloud
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'beta'

      # âœ… Step 3: Authenticate with service account
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # âœ… Step 4: Verify authentication and registry
      - name: Verify gcloud setup
        run: |
          gcloud auth list
          gcloud config list
          gcloud artifacts repositories list --location=asia-south1

      # âœ… Step 5: Configure Docker authentication for Artifact Registry
      - name: Configure Docker authentication
        run: |
          echo "ðŸ” Configuring Docker authentication for Artifact Registry..."
          gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet

      # âœ… Step 6: Build Docker image
      - name: Build Docker image
        run: |
          echo "ðŸ—ï¸ Building Docker image..."
          docker build -t asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/deliveryinventory-repo/deliveryinventoryservice:latest .

      # âœ… Step 7: Check if repository exists (auto-create if missing)
      - name: Ensure Artifact Registry exists
        run: |
          echo "ðŸ§© Ensuring Artifact Registry repository exists..."
          if ! gcloud artifacts repositories describe deliveryinventory-repo --location=asia-south1 >/dev/null 2>&1; then
            echo "ðŸ†• Creating repository deliveryinventory-repo..."
            gcloud artifacts repositories create deliveryinventory-repo \
              --repository-format=docker \
              --location=asia-south1 \
              --description="Docker repo for DeliveryInventoryService"
          else
            echo "âœ… Repository deliveryinventory-repo already exists."
          fi

      # âœ… Step 8: Push Docker image
      - name: Push Docker image
        run: |
          echo "ðŸ“¦ Pushing image to Artifact Registry..."
          docker push asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/deliveryinventory-repo/deliveryinventoryservice:latest

      # âœ… Step 9: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          echo "ðŸš€ Deploying to Cloud Run..."
          gcloud run deploy deliveryinventoryservice \
            --image asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/deliveryinventory-repo/deliveryinventoryservice:latest \
            --platform managed \
            --region asia-south1 \
            --allow-unauthenticated